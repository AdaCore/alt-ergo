##########################################################################
#                                                                        #
#     The Alt-Ergo theorem prover                                        #
#     Copyright (C) 2006-2011                                            #
#                                                                        #
#     Sylvain Conchon                                                    #
#     Evelyne Contejean                                                  #
#                                                                        #
#     Francois Bobot                                                     #
#     Mohamed Iguernelala                                                #
#     Stephane Lescuyer                                                  #
#     Alain Mebsout                                                      #
#                                                                        #
#     CNRS - INRIA - Universite Paris Sud                                #
#                                                                        #
#   This file is distributed under the terms of the CeCILL-C licence     #
#                                                                        #
##########################################################################

# sample Makefile for Objective Caml
# Copyright (C) 2001 Jean-Christophe FILLIATRE
# 
# This library is free software; you can redistribute it and/or
# modify it under the terms of the GNU Library General Public
# License version 2, as published by the Free Software Foundation.
# 
# This library is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
# 
# See the GNU Library General Public License version 2 for more details
# (enclosed in the file LGPL).

# where to install the binaries
DESTDIR=
prefix=@prefix@
exec_prefix=@exec_prefix@
BINDIR=$(DESTDIR)@bindir@
LIBDIR=$(DESTDIR)@libdir@/alt-ergo
DATADIR=$(DESTDIR)@datadir@

# where to install the man page
MANDIR=$(DESTDIR)@mandir@

# other variables set by ./configure
OCAMLC   = @OCAMLC@
OCAMLOPT = @OCAMLOPT@
OCAMLDEP = @OCAMLDEP@
OCAMLLEX = @OCAMLLEX@
OCAMLYACC= @OCAMLYACC@
OCAMLBEST = @OCAMLBEST@
OCAMLVERSION = @OCAMLVERSION@
OCAMLWIN32 = @OCAMLWIN32@
EXE = @EXE@
ENABLEGUI = @ENABLEGUI@

INCLUDES = @OCAMLGRAPHLIB@ @LABLGTK2LIB@

BFLAGS = -annot -g $(INCLUDES)
OFLAGS = -annot $(INCLUDES) -for-pack AltErgo

BIBBYTE = nums.cma graph.cma unix.cma

BIBOPT = $(BIBBYTE:.cma=.cmxa)

BIBGUIBYTE = threads.cma lablgtk.cma lablgtksourceview2.cma gtkThread.cmo
BIBGUIOPT = threads.cmxa lablgtk.cmxa lablgtksourceview2.cmxa gtkThread.cmx

# main target
#############

NAME = alt-ergo
LIBNAME = altErgo
BYTE=$(NAME).byte
OPT=$(NAME).opt
GNATPROVE_NAME=alt-ergo-gp

all: pack xpack $(OCAMLBEST) pack xpack gui META


# bytecode and native-code compilation
######################################

PRECMO = version.cmo print_color.cmo preoptions.cmo

OPTIONSCMO = parseoptions.cmo

CMO = timers.cmo options.cmo exception.cmo loc.cmo hashcons.cmo hstring.cmo \
      symbols.cmo subst.cmo ty.cmo common.cmo existantial.cmo \
      why_parser.cmo why_lexer.cmo pretty.cmo smt_parser.cmo smt_lex.cmo \
      smt_to_why.cmo smtlib2_util.cmo smtlib2_ast.cmo smtlib2_parse.cmo \
      smtlib2_lex.cmo smtlib2_to_why.cmo triggers.cmo why_typing.cmo \
      term.cmo literal.cmo formula.cmo cnf.cmo matching.cmo explanation.cmo \
      polynome.cmo ac.cmo intervals.cmo fm.cmo arith.cmo \
      records.cmo bitv.cmo arrays.cmo sum.cmo combine.cmo \
      incr_match.cmo boxed.cmo instantiation.cmo custom_theory.cmo \
      uf.cmo use.cmo cc.cmo selection.cmo selection_sat.cmo simplify.cmo \
      sat.cmo 

CMOFRONT = pruning.cmo frontend.cmo

PRECMX = $(PRECMO:.cmo=.cmx)
OPTIONSCMX = $(OPTIONSCMO:.cmo=.cmx)
CMX = $(CMO:.cmo=.cmx)
CMXFRONT = $(CMOFRONT:.cmo=.cmx)

MAINCMO = $(CMO) $(CMOFRONT) main.cmo
MAINCMX = $(MAINCMO:.cmo=.cmx)

RUNCMO = $(CMO) run.cmo
RUNCMX = $(RUNCMO:.cmo=.cmx)

GENERATED = version.ml \
	why_parser.ml why_parser.mli why_lexer.ml \
	smt_parser.ml smt_parser.mli smt_lex.ml \
	smtlib2_parse.ml smtlib2_parse.mli smtlib2_lex.ml


ifeq ($(ENABLEGUI),yes)
	GUICMO = $(CMO) $(CMOFRONT) gui_session.cmo why_annoted.cmo \
	   why_connected.cmo gui_replay.cmo gui.cmo
else 
	GUICMO = 
endif


GUICMX = $(GUICMO:.cmo=.cmx)


byte: $(NAME).byte
opt: $(NAME).opt

$(NAME).byte: $(PRECMO) $(OPTIONSCMO) $(MAINCMO) 
	$(if $(QUIET),@echo 'Linking $@' &&) 
	$(OCAMLC) $(BFLAGS) -o $@ $(BIBBYTE) $^

$(LIBNAME).cmo: $(PRECMO) $(CMO) 
	$(if $(QUIET),@echo 'Library $@' &&) 
	$(OCAMLC) $(BFLAGS) -pack -o $(LIBNAME).cmo $^

pack: $(LIBNAME).cmo

$(LIBNAME).cmx: $(PRECMX) $(CMX)
	$(if $(QUIET),@echo 'Library $@' &&) 
	$(OCAMLOPT) $(INCLUDES)  -pack -o $(LIBNAME).cmx $^

xpack: $(LIBNAME).cmx

$(NAME).opt: $(PRECMX) $(OPTIONSCMX) $(MAINCMX)
	$(if $(QUIET),@echo 'Linking $@' &&) 
	$(OCAMLOPT) $(OFLAGS) -o $@ $(BIBOPT) $^

.PHONY: gui

ifeq ($(ENABLEGUI),yes)
gui: altgr-ergo.opt

altgr-ergo.opt: $(PRECMX) $(OPTIONSCMX) $(GUICMX)
	$(if $(QUIET),@echo 'Linking $@' &&) 
	$(OCAMLOPT) $(OFLAGS) -o altgr-ergo.opt $(BIBOPT) $(BIBGUIOPT) $^
else
gui: $(PRECMX) $(OPTIONSCMX) $(GUICMX)
	@echo "gui compilation skipped (lablgtksourceview not detected)"
endif


guibyte: $(PRECMO) $(OPTIONSCMO) $(GUICMO)
	$(if $(QUIET),@echo 'Linking $@' &&) 
	$(OCAMLC) $(BFLAGS) -o altgr-ergo.byte $(BIBBYTE) $(BIBGUIBYTE) $^

test: $(OPT)
	./$(OPT) test.mlw

testbyte:$(BYTE)
	tests/test.sh $(BYTE) -glouton

testopt:$(OPT)
	make -C util/
	tests/test.sh " ./$(OPT) -glouton -triggers-var -arrays "

testproof:$(OPT)
	make -C util/
	tests/test.sh " ./$(OPT) -glouton -triggers-var -arrays -proof -debug-proof"

challenge:$(OPT)
	make -C util/
	tests/challenge.sh " ./$(OPT) "


testoptsel:$(OPT)
	tests/test.sh "./$(OPT) -select 2 -glouton -triggers-var "



VERSION=0.96

#We use the filename of a file in order to create a depency between version.ml
#and the result of ./revision.sh
REVISION:=$(VERSION)$(shell ./revision.sh)
REVISIONSUFFIX:=make.revision
REVISIONFILE:=$(REVISION).$(REVISIONSUFFIX)
$(REVISIONFILE):
	@rm -f *.$(REVISIONSUFFIX)
	@touch $@

version.ml: config.status $(REVISIONFILE)
# set version (and possibly revision) value in version.ml
	@echo "let version = \""$(VERSION)"\"" > version.ml
	@echo "let date = \""`date`"\"" >> version.ml
	@echo "let libdir = \""$(LIBDIR)"\"" >> version.ml

META: config.status $(REVISIONFILE)
	@echo "description = \"API of Alt-Ergo: An automatic theorem prover dedicated to program verification\"" > META
	@echo "version = \""$(REVISION)"\"" >> META
	@echo "archive(byte) = \"altErgo.cmo\"" >> META
	@echo "archive(native) = \"altErgo.cmx\"" >> META
	@echo "requires = \"unix num ocamlgraph\"" >> META


# file headers
##############
headers:
	headache -c doc/headache_config.txt -h doc/ergoheader.txt \
		Makefile.in configure.in README INSTALL \
		*.ml *.ml[ily]


# installation
##############

install-indep: install-man install-pack

install-byte: install-indep
	mkdir -p $(BINDIR)
	cp -f $(NAME).byte $(BINDIR)/$(NAME)$(EXE)

install-opt: install-indep
	mkdir -p $(BINDIR)
	cp -f $(NAME).opt $(BINDIR)/$(NAME)$(EXE)

install-man:
	mkdir -p $(MANDIR)/man1
	cp -f doc/*.1 $(MANDIR)/man1

install: install-indep
	mkdir -p $(BINDIR)
	cp -f $(NAME).$(OCAMLBEST) $(BINDIR)/$(GNATPROVE_NAME)$(EXE)
ifeq ($(ENABLEGUI),yes)
	cp -f altgr-ergo.opt $(BINDIR)/altgr-ergo$(EXE)
	mkdir -p $(DATADIR)/gtksourceview-2.0/language-specs
	cp -f util/gtk-lang/alt-ergo.lang $(DATADIR)/gtksourceview-2.0/language-specs/alt-ergo.lang
endif

install-pack: xpack pack META
	mkdir -p $(LIBDIR)
	cp -f $(LIBNAME).cmx $(LIBDIR)
	cp -f $(LIBNAME).o $(LIBDIR)
	cp -f $(LIBNAME).cmo $(LIBDIR)
	cp -f $(LIBNAME).cmi $(LIBDIR)
	cp -f META $(LIBDIR)

# documentation
###############

DOCFILES=

doc: $(DOCFILES)

# export
########

EXPORTDIR=$(NAME)-$(VERSION)
TAR=$(EXPORTDIR).tar

HTTP = $$HOME/WWW/ergo/http
ERGOWEB = $$HOME/WWW/ergo/

FILES = exception.mli exception.ml \
	print_color.mli print_color.ml \
	preoptions.ml preoptions.mli \
	timers.mli timers.ml \
	parseoptions.ml options.mli options.ml \
	loc.ml sig.mli \
	hashcons.mli hashcons.ml \
	hstring.mli hstring.ml	\
	symbols.ml symbols.mli \
	subst.mli subst.ml \
	ty.mli ty.ml \
	common.mli common.ml \
	term.mli term.ml \
	literal.mli literal.ml \
	formula.mli formula.ml \
	boxed.mli boxed.ml explanation.mli explanation.ml \
	why_ptree.mli why_parser.mly why_lexer.mll \
	smt_ast.mli smt_parser.mly smt_lex.mll smt_to_why.ml \
	smtlib2_util.ml smtlib2_ast.ml \
	smtlib2_parse.mly smtlib2_lex.mll smtlib2_to_why.ml \
	pruning.mli pruning.ml \
	selection.mli selection.ml \
	selection_sat.mli selection_sat.ml \
	simplify.mli simplify.ml \
	existantial.mli existantial.ml \
	triggers.mli triggers.ml \
	cnf.mli cnf.ml \
	why_typing.mli why_typing.ml \
	pretty.mli pretty.ml \
	polynome.mli polynome.ml \
	uf.mli uf.ml \
	use.mli use.ml \
	intervals.mli intervals.ml \
	fm.mli fm.ml \
	arith.mli arith.ml \
	records.mli records.ml \
	arrays.ml arrays.mli \
	sum.ml sum.mli \
	bitv.mli bitv.ml \
	incr_match.ml incr_match.mli instantiation.ml instantiation.mli \
	custom_theory.ml custom_theory.mli\
	combine.mli combine.ml cc.mli cc.ml ac.ml ac.mli\
	matching.mli matching.ml \
	sat.mli sat.ml \
	frontend.mli frontend.ml \
	gui_session.mli gui_session.ml why_annoted.mli why_annoted.ml \
	why_connected.mli why_connected.ml gui_replay.mli gui_replay.ml \
	gui.ml \
	main.ml \
	Makefile.in configure configure.in \
	.depend README INSTALL COPYING CeCILL-C CHANGES\
	revision.sh

export: source binary
	cp README COPYING CeCILL-C CHANGES doc/*.1 $(HTTP)
	rm -rf export/$(EXPORTDIR)
	rm -rf $(HTTP)/$(EXPORTDIR)
	mv export $(HTTP)/$(EXPORTDIR)

source: 
	mkdir -p export/$(EXPORTDIR)
	mkdir -p export/$(EXPORTDIR)/doc
	mkdir -p export/$(EXPORTDIR)/util
	mkdir -p export/$(EXPORTDIR)/util/gtk-lang
	cp $(FILES) export/$(EXPORTDIR)
	cp doc/$(NAME).1 export/$(EXPORTDIR)/doc
	cp util/gtk-lang/alt-ergo.lang export/$(EXPORTDIR)/util/gtk-lang/
	cd export ; tar cf $(TAR) $(EXPORTDIR) ; gzip -f --best $(TAR)


BINARY = $(EXPORTDIR)-$$OSTYPE
BINARYTAR=$(BINARY).tar
ARCH = $(shell uname -m)
BINARYFILES = README INSTALL COPYING CeCILL-C doc/$(NAME).1

binary: $(OPT)
	strip $(OPT)
	cp $(OPT) export/alt-ergo-$(VERSION)-$(ARCH)

# generic rules
###############

.SUFFIXES: .mli .ml .cmi .cmo .cmx .mll .mly .tex .dvi .ps .html

.mli.cmi:
	@@OCAMLWIZARD@ compile -w a $(BFLAGS) $< 
	$(if $(QUIET),@echo 'Compiling $@' &&) $(OCAMLC) -c $(BFLAGS) $<

.ml.cmo:
	$(if $(QUIET),@echo 'Compiling $@' &&) $(OCAMLC) -c $(BFLAGS) $<
	@@OCAMLWIZARD@ compile -w a $(BFLAGS) $< 

.ml.o:
	@@OCAMLWIZARD@ compile -w a $(BFLAGS) $< 
	$(if $(QUIET),@echo 'Compiling $@' &&) $(OCAMLOPT) -c $(OFLAGS) $<

.ml.cmx:
	$(if $(QUIET),@echo 'Compiling $@' &&) $(OCAMLOPT) -c $(OFLAGS) $<
	@@OCAMLWIZARD@ compile -w a $(BFLAGS) $< 

.mll.ml:
	$(if $(QUIET),@echo 'Compiling $<' &&) $(OCAMLLEX) $< > /dev/null

.mly.ml:
	$(if $(QUIET),@echo 'Compiling $<' &&) $(OCAMLYACC) -v $< 

.mly.mli:
	$(if $(QUIET),@echo 'Compiling $<' &&) $(OCAMLYACC) -v $< 


# Makefile is rebuilt whenever Makefile.in or configure.in is modified
######################################################################

Makefile: Makefile.in config.status
	./config.status

config.status: configure
	./config.status --recheck

configure: configure.in
	autoconf 

# clean
#######

clean:: 
	@rm -f *.cm[ioxt] *.cmti *.o *~ *.annot *.owz *mlocamlwizard_tmp_file*
	@rm -f $(GENERATED) *.output
	@rm -f $(NAME).byte $(NAME).opt
	@rm -f unittest/*.cm[iox] unittest/*.o unittest/*.annot
	@rm -f *.aux *.log $(NAME).tex $(NAME).dvi $(NAME).ps
	@rm -f version.ml
	@rm -f altgr-ergo.opt
	@rm -f *.$(REVISIONSUFFIX)

dist-clean distclean:: clean
	@rm -f Makefile config.cache config.log config.status

# depend
########

.depend depend:: $(GENERATED)
	@rm -f .depend
	@$(OCAMLDEP) -slash *.ml *.mli > .depend

include .depend
